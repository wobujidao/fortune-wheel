<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
    padding: 20px;
  }

  h1 {
    text-align: center;
    font-size: 22px;
    color: #ffd700;
    margin-bottom: 20px;
  }

  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .tab {
    padding: 10px 18px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    color: #ccc;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }

  .tab:hover { background: rgba(255,255,255,0.12); }
  .tab.active { background: #ffd700; color: #1a1a2e; font-weight: 700; border-color: #ffd700; }

  .panel { display: none; }
  .panel.active { display: block; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 12px;
  }

  th, td {
    padding: 10px 8px;
    text-align: left;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  th { color: #ffd700; font-weight: 600; font-size: 12px; text-transform: uppercase; }

  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: opacity 0.2s;
  }

  .btn:hover { opacity: 0.85; }
  .btn-gold { background: #ffd700; color: #1a1a2e; }
  .btn-red { background: #e74c3c; color: #fff; }
  .btn-green { background: #27ae60; color: #fff; }
  .btn-small { padding: 5px 10px; font-size: 12px; }

  .actions { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }

  .stat-card {
    background: rgba(255,255,255,0.06);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    text-align: center;
  }

  .stat-card .num { font-size: 32px; font-weight: 700; color: #ffd700; }
  .stat-card .label { font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 4px; }

  .form-group { margin-bottom: 12px; }
  .form-group label { display: block; font-size: 13px; color: #aaa; margin-bottom: 4px; }
  .form-group input, .form-group select {
    width: 100%;
    padding: 10px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
  }

  .msg {
    padding: 10px 14px;
    border-radius: 8px;
    margin-bottom: 12px;
    font-size: 13px;
    display: none;
  }

  .msg.ok { background: rgba(39,174,96,0.2); color: #2ecc71; display: block; }
  .msg.err { background: rgba(231,76,60,0.2); color: #e74c3c; display: block; }

  .no-access {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255,255,255,0.5);
    font-size: 16px;
  }

  .dev-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
    padding: 10px 16px;
    background: rgba(255,255,255,0.04);
    border-radius: 10px;
  }

  .dev-toggle label {
    font-size: 13px;
    color: #aaa;
    cursor: pointer;
  }

  .dev-switch {
    position: relative;
    width: 44px;
    height: 24px;
    cursor: pointer;
  }

  .dev-switch input { display: none; }

  .dev-switch .slider {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.15);
    border-radius: 12px;
    transition: background 0.3s;
  }

  .dev-switch .slider::after {
    content: '';
    position: absolute;
    top: 3px; left: 3px;
    width: 18px; height: 18px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.3s;
  }

  .dev-switch input:checked + .slider {
    background: #27ae60;
  }

  .dev-switch input:checked + .slider::after {
    transform: translateX(20px);
  }

  /* Drag & Drop */
  tr[draggable="true"] { cursor: grab; }
  tr[draggable="true"]:active { cursor: grabbing; }
  tr.dragging { opacity: 0.4; }
  tr.drag-over td { border-top: 2px solid #ffd700; }

  /* Stats bars */
  .stats-section { margin-bottom: 24px; }
  .stats-section h3 { font-size: 14px; color: #ffd700; margin-bottom: 10px; }
  .stat-bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; }
  .stat-bar-label { width: 40%; min-width: 80px; color: rgba(255,255,255,0.8); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .stat-bar-track { flex: 1; height: 20px; background: rgba(255,255,255,0.06); border-radius: 4px; overflow: hidden; }
  .stat-bar-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, #ffd700, #ff8c00); transition: width 0.4s ease; display: flex; align-items: center; padding-left: 6px; font-size: 11px; font-weight: 700; color: #1a1a2e; min-width: 24px; }
  .stat-bar-fill.teal { background: linear-gradient(90deg, #2dd4bf, #0891b2); }

  /* Audit log table */
  .action-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    background: rgba(255,255,255,0.08);
  }

  /* Settings pointer style */
  .style-options { display: flex; gap: 12px; flex-wrap: wrap; }
  .style-card {
    flex: 1;
    min-width: 120px;
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }
  .style-card:hover { border-color: rgba(255,215,0,0.4); }
  .style-card.selected { border-color: #ffd700; background: rgba(255,215,0,0.08); }
  .style-card .style-icon { font-size: 40px; margin-bottom: 8px; display: block; }
  .style-card .style-label { font-size: 13px; font-weight: 600; color: #e0e0e0; }
  .style-card .style-desc { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 4px; }

  @media (max-width: 600px) {
    table { font-size: 11px; }
    th, td { padding: 7px 4px; }
  }
</style>
</head>
<body>

<div id="app" style="display:none; max-width: 800px; margin: 0 auto;">
  <h1>üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>

  <div class="tabs">
    <div class="tab active" onclick="showTab('results')">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
    <div class="tab" onclick="showTab('prizes')">–ü—Ä–∏–∑—ã</div>
    <div class="tab" onclick="showTab('users')">–î–æ—Å—Ç—É–ø</div>
    <div class="tab" onclick="showTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div class="tab" onclick="showTab('audit')">–õ–æ–≥</div>
  </div>

  <div class="dev-toggle">
    <label for="devModeSwitch">–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏</label>
    <label class="dev-switch">
      <input type="checkbox" id="devModeSwitch" onchange="toggleDevMode(this.checked)">
      <span class="slider"></span>
    </label>
  </div>

  <div id="msg" class="msg"></div>

  <!-- ============ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã ============ -->
  <div id="panel-results" class="panel active">
    <div class="stat-card">
      <div class="num" id="totalSpins">‚Äî</div>
      <div class="label">–≤—Å–µ–≥–æ –≤—Ä–∞—â–µ–Ω–∏–π</div>
    </div>
    <div class="form-group" style="margin-bottom:12px">
      <input id="searchResults" type="text" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, username –∏–ª–∏ Telegram ID..." oninput="filterResults()">
    </div>
    <div class="actions">
      <button class="btn btn-gold" onclick="exportCSV()">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      <button class="btn btn-red" onclick="resetResults()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
    </div>
    <div id="statsContainer"></div>
    <table>
      <thead>
        <tr><th>ID</th><th>Telegram ID</th><th>Username</th><th>–ò–º—è</th><th>–ü—Ä–∏–∑</th><th>–î–∞—Ç–∞</th><th></th></tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>

  <!-- ============ –ü—Ä–∏–∑—ã ============ -->
  <div id="panel-prizes" class="panel">
    <div class="actions">
      <button class="btn btn-green" onclick="showAddPrize()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑</button>
    </div>
    <div id="prizeForm" style="display:none; background: rgba(255,255,255,0.04); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
      <div id="prizeFormTitle" style="font-size:14px; font-weight:600; color:#ffd700; margin-bottom:12px;">–ù–æ–≤—ã–π –ø—Ä–∏–∑</div>
      <input type="hidden" id="editPrizeId" value="">
      <div class="form-group"><label>–¢–µ–∫—Å—Ç –ø—Ä–∏–∑–∞</label><input id="newPrizeText" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π"></div>
      <div class="form-group"><label>–ò–∫–æ–Ω–∫–∞ (—ç–º–æ–¥–∑–∏)</label><input id="newPrizeIcon" placeholder="üå¥" maxlength="4"></div>
      <div class="form-group"><label>–¶–≤–µ—Ç</label><input id="newPrizeColor" type="color" value="#4A90D9"></div>
      <div class="form-group"><label>–ü–æ–∑–∏—Ü–∏—è</label><input id="newPrizePosition" type="number" min="1" max="100" value="1"></div>
      <div class="form-group" id="prizeActiveGroup" style="display:none;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="checkbox" id="newPrizeActive" checked> –ê–∫—Ç–∏–≤–µ–Ω
        </label>
      </div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn btn-green" onclick="savePrize()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-small" style="background:rgba(255,255,255,0.1);color:#ccc;" onclick="closePrizeForm()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
    <table>
      <thead>
        <tr><th>‚Ññ</th><th>–ò–∫–æ–Ω–∫–∞</th><th>–ü—Ä–∏–∑</th><th>–¶–≤–µ—Ç</th><th>–ê–∫—Ç–∏–≤–µ–Ω</th><th></th></tr>
      </thead>
      <tbody id="prizesBody"></tbody>
    </table>
  </div>

  <!-- ============ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ============ -->
  <div id="panel-settings" class="panel">
    <h3 style="font-size:14px; color:#ffd700; margin-bottom:12px;">–°—Ç–∏–ª—å —É–∫–∞–∑–∞—Ç–µ–ª—è</h3>
    <div class="style-options" id="pointerStyleOptions">
      <div class="style-card" data-value="top" onclick="setPointerStyle('top')">
        <span class="style-icon">‚¨áÔ∏è</span>
        <div class="style-label">–°–≤–µ—Ä—Ö—É</div>
        <div class="style-desc">–°—Ç—Ä–µ–ª–∫–∞ —Å–≤–µ—Ä—Ö—É –∫–æ–ª–µ—Å–∞, –æ—Å—Ç—Ä–∏—ë–º –∫ —Ü–µ–Ω—Ç—Ä—É</div>
      </div>
      <div class="style-card" data-value="center" onclick="setPointerStyle('center')">
        <span class="style-icon">‚¨ÜÔ∏è</span>
        <div class="style-label">–ò–∑ —Ü–µ–Ω—Ç—Ä–∞</div>
        <div class="style-desc">–°—Ç—Ä–µ–ª–∫–∞ –∏–∑ —Ö–∞–±–∞ –≤–≤–µ—Ä—Ö, —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–∏–∑</div>
      </div>
    </div>
  </div>

  <!-- ============ –õ–æ–≥ ============ -->
  <div id="panel-audit" class="panel">
    <table>
      <thead>
        <tr><th>–î–∞—Ç–∞</th><th>–ê–¥–º–∏–Ω</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–î–µ—Ç–∞–ª–∏</th></tr>
      </thead>
      <tbody id="auditBody"></tbody>
    </table>
  </div>

  <!-- ============ –î–æ—Å—Ç—É–ø ============ -->
  <div id="panel-users" class="panel">
    <div style="background: rgba(255,255,255,0.04); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
      <div class="form-group"><label>Telegram ID</label><input id="newUserId" type="number" placeholder="123456789"></div>
      <div class="form-group">
        <label>–†–æ–ª—å</label>
        <select id="newUserRole"><option value="admin">–ê–¥–º–∏–Ω</option><option value="viewer">–ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫</option></select>
      </div>
      <button class="btn btn-green" onclick="addUser()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <table>
      <thead>
        <tr><th>ID</th><th>Telegram ID</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–†–æ–ª—å</th><th>–î–æ–±–∞–≤–∏–ª</th><th></th></tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>
  </div>
</div>

<div id="noAccess" class="no-access" style="display:none;">
  ‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.<br>–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ Telegram Mini App.
</div>

<script>
const tg = window.Telegram && window.Telegram.WebApp;
let initData = '';

if (tg) {
  tg.ready();
  initData = tg.initData || '';
}

function headers() {
  return { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': initData };
}

function showMsg(text, ok) {
  const el = document.getElementById('msg');
  el.textContent = text;
  el.className = 'msg ' + (ok ? 'ok' : 'err');
  setTimeout(() => { el.className = 'msg'; }, 3000);
}

const TAB_NAMES = { results: '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã', prizes: '–ü—Ä–∏–∑—ã', users: '–î–æ—Å—Ç—É–ø', settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', audit: '–õ–æ–≥' };
function showTab(name) {
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.toggle('active', t.textContent.trim() === TAB_NAMES[name]);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  if (name === 'results') loadResults();
  if (name === 'prizes') loadPrizes();
  if (name === 'users') loadUsers();
  if (name === 'settings') loadSettings();
  if (name === 'audit') loadAudit();
}

// ---- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã ----
let allResults = [];

async function loadResults() {
  try {
    const res = await fetch('/api/admin/results', { headers: headers() });
    if (!res.ok) throw new Error(res.status);
    allResults = await res.json();
    document.getElementById('totalSpins').textContent = allResults.length;
    document.getElementById('searchResults').value = '';
    renderResults(allResults);
    renderStats();
  } catch (e) {
    document.getElementById('noAccess').style.display = 'block';
    document.getElementById('app').style.display = 'none';
  }
}

function filterResults() {
  const q = document.getElementById('searchResults').value.toLowerCase().trim();
  if (!q) { renderResults(allResults); return; }
  const filtered = allResults.filter(s =>
    (s.tg_username || '').toLowerCase().includes(q) ||
    (s.tg_first_name || '').toLowerCase().includes(q) ||
    (s.tg_last_name || '').toLowerCase().includes(q) ||
    String(s.tg_user_id).includes(q)
  );
  renderResults(filtered);
}

function renderResults(data) {
  const tbody = document.getElementById('resultsBody');
  tbody.innerHTML = '';
  data.forEach(s => {
    const tr = document.createElement('tr');
    [s.id, s.tg_user_id, '@' + (s.tg_username || '‚Äî'), (s.tg_first_name || '') + ' ' + (s.tg_last_name || ''), s.prize_text, s.created_at ? new Date(s.created_at).toLocaleString('ru') : ''].forEach(val => {
      const td = document.createElement('td');
      td.textContent = val;
      tr.appendChild(td);
    });
    const tdBtn = document.createElement('td');
    const btn = document.createElement('button');
    btn.className = 'btn btn-red btn-small';
    btn.textContent = '‚úï';
    btn.addEventListener('click', () => deleteResult(s.id));
    tdBtn.appendChild(btn);
    tr.appendChild(tdBtn);
    tbody.appendChild(tr);
  });
}

async function deleteResult(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å #' + id + '?')) return;
  try {
    const res = await fetch('/api/admin/results/' + id, { method: 'DELETE', headers: headers() });
    if (res.ok) { showMsg('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', true); loadResults(); }
    else showMsg('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', false);
  } catch (e) { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); }
}

async function resetResults() {
  if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –í–°–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã? –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –∫—Ä—É—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ.')) return;
  try {
    const res = await fetch('/api/admin/reset', { method: 'POST', headers: headers() });
    if (res.ok) { showMsg('–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã', true); loadResults(); }
    else showMsg('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞', false);
  } catch (e) { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); }
}

async function exportCSV() {
  try {
    const res = await fetch('/api/admin/export', { headers: headers() });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();

    // –í Telegram WebView: –∫–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (—Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
    if (tg) {
      await navigator.clipboard.writeText(text);
      showMsg('CSV —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ ‚Äî –≤—Å—Ç–∞–≤—å—Ç–µ –≤ —Ñ–∞–π–ª –∏–ª–∏ —á–∞—Ç', true);
      return;
    }

    // –í –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ: —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'results.csv';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 3000);
  } catch (e) {
    showMsg('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message, false);
  }
}

// ---- –ü—Ä–∏–∑—ã ----
async function loadPrizes() {
  try {
    const res = await fetch('/api/admin/prizes', { headers: headers() });
    if (!res.ok) { showMsg('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–∑–æ–≤', false); return; }
    var data = await res.json();
  } catch (e) { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); return; }
  const tbody = document.getElementById('prizesBody');
  tbody.innerHTML = '';
  data.forEach(p => {
    const tr = document.createElement('tr');
    tr.dataset.prizeId = p.id;
    const tdPos = document.createElement('td'); tdPos.textContent = p.position; tr.appendChild(tdPos);
    const tdIcon = document.createElement('td'); tdIcon.style.fontSize = '20px'; tdIcon.textContent = p.icon; tr.appendChild(tdIcon);
    const tdText = document.createElement('td'); tdText.textContent = p.text; tr.appendChild(tdText);
    const tdColor = document.createElement('td');
    const span = document.createElement('span');
    span.style.cssText = 'display:inline-block;width:20px;height:20px;border-radius:4px;background:' + p.color;
    tdColor.appendChild(span);
    tdColor.append(' ' + p.color);
    tr.appendChild(tdColor);
    const tdActive = document.createElement('td'); tdActive.textContent = p.is_active ? '‚úÖ' : '‚ùå'; tr.appendChild(tdActive);
    const tdBtn = document.createElement('td');
    tdBtn.style.cssText = 'display:flex; gap:4px;';
    const btnEdit = document.createElement('button');
    btnEdit.className = 'btn btn-gold btn-small';
    btnEdit.textContent = '‚úèÔ∏è';
    btnEdit.addEventListener('click', () => editPrize(p));
    tdBtn.appendChild(btnEdit);
    const btn = document.createElement('button');
    btn.className = 'btn btn-red btn-small';
    btn.textContent = '‚úï';
    btn.addEventListener('click', () => deletePrize(p.id));
    tdBtn.appendChild(btn);
    tr.appendChild(tdBtn);
    tbody.appendChild(tr);
  });
  enablePrizeDragDrop();
}

function showAddPrize() {
  document.getElementById('editPrizeId').value = '';
  document.getElementById('prizeFormTitle').textContent = '–ù–æ–≤—ã–π –ø—Ä–∏–∑';
  document.getElementById('newPrizeText').value = '';
  document.getElementById('newPrizeIcon').value = '';
  document.getElementById('newPrizeColor').value = '#4A90D9';
  document.getElementById('newPrizePosition').value = '1';
  document.getElementById('newPrizeActive').checked = true;
  document.getElementById('prizeActiveGroup').style.display = 'none';
  document.getElementById('prizeForm').style.display = 'block';
}

function editPrize(p) {
  document.getElementById('editPrizeId').value = p.id;
  document.getElementById('prizeFormTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞ #' + p.id;
  document.getElementById('newPrizeText').value = p.text;
  document.getElementById('newPrizeIcon').value = p.icon;
  document.getElementById('newPrizeColor').value = p.color;
  document.getElementById('newPrizePosition').value = p.position;
  document.getElementById('newPrizeActive').checked = p.is_active;
  document.getElementById('prizeActiveGroup').style.display = 'block';
  document.getElementById('prizeForm').style.display = 'block';
}

function closePrizeForm() {
  document.getElementById('prizeForm').style.display = 'none';
}

async function savePrize() {
  const editId = document.getElementById('editPrizeId').value;
  const text = document.getElementById('newPrizeText').value.trim();
  const icon = document.getElementById('newPrizeIcon').value.trim();
  const color = document.getElementById('newPrizeColor').value;
  const position = parseInt(document.getElementById('newPrizePosition').value) || 1;
  if (!text || !icon) { showMsg('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ –∏–∫–æ–Ω–∫—É', false); return; }

  let res;
  if (editId) {
    const is_active = document.getElementById('newPrizeActive').checked;
    res = await fetch('/api/admin/prizes/' + editId, {
      method: 'PUT',
      headers: headers(),
      body: JSON.stringify({ text, icon, color, position, is_active })
    });
  } else {
    res = await fetch('/api/admin/prizes', {
      method: 'POST',
      headers: headers(),
      body: JSON.stringify({ text, icon, color, position })
    });
  }

  if (res.ok) {
    showMsg(editId ? '–ü—Ä–∏–∑ –æ–±–Ω–æ–≤–ª—ë–Ω' : '–ü—Ä–∏–∑ –¥–æ–±–∞–≤–ª–µ–Ω', true);
    closePrizeForm();
    loadPrizes();
  } else {
    const err = await res.json().catch(() => ({}));
    showMsg(err.detail || '–û—à–∏–±–∫–∞', false);
  }
}

async function deletePrize(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∑ #' + id + '?')) return;
  const res = await fetch('/api/admin/prizes/' + id, { method: 'DELETE', headers: headers() });
  if (res.ok) { showMsg('–ü—Ä–∏–∑ —É–¥–∞–ª—ë–Ω', true); loadPrizes(); }
  else {
    const err = await res.json().catch(() => ({}));
    showMsg(err.detail || '–û—à–∏–±–∫–∞', false);
  }
}

// ---- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ----
async function loadUsers() {
  let data;
  try {
    const res = await fetch('/api/admin/users', { headers: headers() });
    if (!res.ok) { showMsg('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', false); return; }
    data = await res.json();
  } catch (e) { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); return; }
  const tbody = document.getElementById('usersBody');
  tbody.innerHTML = '';
  data.forEach(u => {
    const tr = document.createElement('tr');
    const userDisplay = u.tg_first_name
      ? u.tg_first_name + (u.tg_username ? ' (@' + u.tg_username + ')' : '')
      : (u.tg_username ? '@' + u.tg_username : '‚Äî');
    [u.id, u.tg_user_id, userDisplay, u.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫', u.added_by || '‚Äî'].forEach(val => {
      const td = document.createElement('td');
      td.textContent = val;
      tr.appendChild(td);
    });
    const tdBtn = document.createElement('td');
    const btn = document.createElement('button');
    btn.className = 'btn btn-red btn-small';
    btn.textContent = '‚úï';
    btn.addEventListener('click', () => deleteUser(u.id));
    tdBtn.appendChild(btn);
    tr.appendChild(tdBtn);
    tbody.appendChild(tr);
  });
}

async function addUser() {
  const tg_user_id = parseInt(document.getElementById('newUserId').value);
  const role = document.getElementById('newUserRole').value;
  if (!tg_user_id) { showMsg('–í–≤–µ–¥–∏—Ç–µ Telegram ID', false); return; }

  const res = await fetch('/api/admin/users', {
    method: 'POST',
    headers: headers(),
    body: JSON.stringify({ tg_user_id, role })
  });
  if (res.ok) {
    showMsg('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω', true);
    document.getElementById('newUserId').value = '';
    loadUsers();
  } else {
    const err = await res.json().catch(() => ({}));
    showMsg(err.detail || '–û—à–∏–±–∫–∞', false);
  }
}

async function deleteUser(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
  try {
    const res = await fetch('/api/admin/users/' + id, { method: 'DELETE', headers: headers() });
    if (res.ok) { showMsg('–£–¥–∞–ª–µ–Ω–æ', true); loadUsers(); }
    else showMsg('–û—à–∏–±–∫–∞', false);
  } catch (e) { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); }
}

// ---- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ----
function renderStats() {
  const container = document.getElementById('statsContainer');
  container.innerHTML = '';
  if (!allResults.length) return;

  // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏–∑–∞–º
  const prizeCounts = {};
  allResults.forEach(s => { prizeCounts[s.prize_text] = (prizeCounts[s.prize_text] || 0) + 1; });
  const prizeEntries = Object.entries(prizeCounts).sort((a, b) => b[1] - a[1]);
  if (!prizeEntries.length) return;
  const maxPrize = prizeEntries[0][1];

  const prizeSection = document.createElement('div');
  prizeSection.className = 'stats-section';
  const prizeH = document.createElement('h3');
  prizeH.textContent = '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–æ–≤';
  prizeSection.appendChild(prizeH);
  prizeEntries.forEach(([name, count]) => {
    const row = document.createElement('div');
    row.className = 'stat-bar-row';
    const label = document.createElement('div');
    label.className = 'stat-bar-label';
    label.textContent = name;
    label.title = name;
    const track = document.createElement('div');
    track.className = 'stat-bar-track';
    const fill = document.createElement('div');
    fill.className = 'stat-bar-fill';
    fill.style.width = Math.round(count / maxPrize * 100) + '%';
    fill.textContent = count;
    track.appendChild(fill);
    row.appendChild(label);
    row.appendChild(track);
    prizeSection.appendChild(row);
  });
  container.appendChild(prizeSection);

  // –í—Ä–∞—â–µ–Ω–∏—è –ø–æ –¥–Ω—è–º
  const dayCounts = {};
  allResults.forEach(s => {
    if (!s.created_at) return;
    const day = s.created_at.substring(0, 10);
    dayCounts[day] = (dayCounts[day] || 0) + 1;
  });
  const dayEntries = Object.entries(dayCounts).sort((a, b) => a[0].localeCompare(b[0]));
  if (dayEntries.length > 1) {
    const maxDay = Math.max(...dayEntries.map(e => e[1]));
    const daySection = document.createElement('div');
    daySection.className = 'stats-section';
    const dayH = document.createElement('h3');
    dayH.textContent = '–í—Ä–∞—â–µ–Ω–∏—è –ø–æ –¥–Ω—è–º';
    daySection.appendChild(dayH);
    dayEntries.forEach(([day, count]) => {
      const row = document.createElement('div');
      row.className = 'stat-bar-row';
      const label = document.createElement('div');
      label.className = 'stat-bar-label';
      label.textContent = new Date(day).toLocaleDateString('ru', { day: 'numeric', month: 'short' });
      const track = document.createElement('div');
      track.className = 'stat-bar-track';
      const fill = document.createElement('div');
      fill.className = 'stat-bar-fill teal';
      fill.style.width = Math.round(count / maxDay * 100) + '%';
      fill.textContent = count;
      track.appendChild(fill);
      row.appendChild(label);
      row.appendChild(track);
      daySection.appendChild(row);
    });
    container.appendChild(daySection);
  }
}

// ---- Drag & Drop –ø—Ä–∏–∑–æ–≤ ----
let dragSrcRow = null;

function enablePrizeDragDrop() {
  const tbody = document.getElementById('prizesBody');
  tbody.querySelectorAll('tr').forEach(tr => {
    tr.setAttribute('draggable', 'true');
    // –°–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
    tr.removeEventListener('dragstart', handleDragStart);
    tr.removeEventListener('dragover', handleDragOver);
    tr.removeEventListener('dragenter', handleDragEnter);
    tr.removeEventListener('dragleave', handleDragLeave);
    tr.removeEventListener('drop', handleDrop);
    tr.removeEventListener('dragend', handleDragEnd);
    tr.addEventListener('dragstart', handleDragStart);
    tr.addEventListener('dragover', handleDragOver);
    tr.addEventListener('dragenter', handleDragEnter);
    tr.addEventListener('dragleave', handleDragLeave);
    tr.addEventListener('drop', handleDrop);
    tr.addEventListener('dragend', handleDragEnd);
  });
}

function handleDragStart(e) {
  dragSrcRow = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(e) {
  e.preventDefault();
  this.classList.add('drag-over');
}

function handleDragLeave() {
  this.classList.remove('drag-over');
}

function handleDrop(e) {
  e.preventDefault();
  if (dragSrcRow === this) return;
  const tbody = this.parentNode;
  const rows = Array.from(tbody.children);
  const srcIdx = rows.indexOf(dragSrcRow);
  const dstIdx = rows.indexOf(this);
  if (srcIdx < dstIdx) {
    tbody.insertBefore(dragSrcRow, this.nextSibling);
  } else {
    tbody.insertBefore(dragSrcRow, this);
  }
  this.classList.remove('drag-over');
  savePrizeOrder();
}

function handleDragEnd() {
  this.classList.remove('dragging');
  document.querySelectorAll('#prizesBody tr').forEach(tr => tr.classList.remove('drag-over'));
}

async function savePrizeOrder() {
  const rows = document.querySelectorAll('#prizesBody tr');
  const items = [];
  rows.forEach((tr, i) => {
    const id = parseInt(tr.dataset.prizeId);
    if (id) items.push({ id, position: i + 1 });
  });
  if (!items.length) return;
  try {
    const res = await fetch('/api/admin/prizes/reorder', {
      method: 'PUT',
      headers: headers(),
      body: JSON.stringify(items)
    });
    if (res.ok) {
      showMsg('–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω', true);
      loadPrizes();
    } else {
      showMsg('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞', false);
      loadPrizes();
    }
  } catch {
    showMsg('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞', false);
    loadPrizes();
  }
}

// ---- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ----
async function loadSettings() {
  try {
    const res = await fetch('/api/settings');
    if (!res.ok) return;
    const data = await res.json();
    highlightPointerStyle(data.pointer_style || 'top');
  } catch {}
}

function highlightPointerStyle(value) {
  document.querySelectorAll('#pointerStyleOptions .style-card').forEach(card => {
    card.classList.toggle('selected', card.dataset.value === value);
  });
}

async function setPointerStyle(value) {
  try {
    const res = await fetch('/api/admin/settings', {
      method: 'PUT',
      headers: headers(),
      body: JSON.stringify({ key: 'pointer_style', value })
    });
    if (res.ok) {
      showMsg('–°—Ç–∏–ª—å —É–∫–∞–∑–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—ë–Ω: ' + (value === 'top' ? '—Å–≤–µ—Ä—Ö—É' : '–∏–∑ —Ü–µ–Ω—Ç—Ä–∞'), true);
      highlightPointerStyle(value);
    } else {
      const err = await res.json().catch(() => ({}));
      showMsg(err.detail || '–û—à–∏–±–∫–∞', false);
    }
  } catch { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); }
}

// ---- –ê—É–¥–∏—Ç-–ª–æ–≥ ----
const ACTION_LABELS = {
  delete_spin: 'üóë –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–∞—â–µ–Ω–∏—è',
  reset_all: 'üîÑ –°–±—Ä–æ—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤',
  create_prize: '‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–∞',
  update_prize: '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞',
  delete_prize: 'üóë –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–∞',
  reorder_prizes: '‚ÜïÔ∏è –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏–∑–æ–≤',
  add_user: 'üë§ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
  delete_user: 'üóë –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
  update_setting: '‚öôÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
};

async function loadAudit() {
  try {
    const res = await fetch('/api/admin/audit', { headers: headers() });
    if (!res.ok) return;
    const data = await res.json();
    const tbody = document.getElementById('auditBody');
    tbody.innerHTML = '';
    data.forEach(log => {
      const tr = document.createElement('tr');
      const tdDate = document.createElement('td');
      tdDate.textContent = log.created_at ? new Date(log.created_at).toLocaleString('ru') : '';
      tr.appendChild(tdDate);
      const tdAdmin = document.createElement('td');
      tdAdmin.textContent = log.admin_name || log.admin_id;
      tr.appendChild(tdAdmin);
      const tdAction = document.createElement('td');
      const badge = document.createElement('span');
      badge.className = 'action-badge';
      badge.textContent = ACTION_LABELS[log.action] || log.action;
      tdAction.appendChild(badge);
      tr.appendChild(tdAction);
      const tdDetails = document.createElement('td');
      tdDetails.textContent = log.details || '';
      tdDetails.style.color = 'rgba(255,255,255,0.6)';
      tdDetails.style.fontSize = '12px';
      tr.appendChild(tdDetails);
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏—Ç-–ª–æ–≥–∞:', e);
  }
}

// ---- –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ----
function toggleDevMode(on) {
  if (on) {
    localStorage.setItem('devMode', '1');
    showMsg('–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á—ë–Ω ‚Äî –∫–æ–ª–µ—Å–æ –º–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π', true);
  } else {
    localStorage.removeItem('devMode');
    showMsg('–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω', true);
  }
}

// ---- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ----
async function initAdmin() {
  // BackButton –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –∞–¥–º–∏–Ω–∫–∏
  if (tg && tg.BackButton) {
    tg.BackButton.show();
    tg.BackButton.onClick(() => tg.close());
  }

  try {
    const res = await fetch('/api/admin/results', { headers: headers() });
    if (res.ok) {
      document.getElementById('app').style.display = 'block';
      document.getElementById('devModeSwitch').checked = localStorage.getItem('devMode') === '1';
      loadResults();
    } else {
      document.getElementById('noAccess').style.display = 'block';
    }
  } catch (e) {
    document.getElementById('noAccess').style.display = 'block';
  }
}

initAdmin();
</script>
</body>
</html>
