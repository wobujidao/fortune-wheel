<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
    padding: 20px;
  }

  h1 {
    text-align: center;
    font-size: 22px;
    color: #ffd700;
    margin-bottom: 20px;
  }

  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .tab {
    padding: 10px 18px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    color: #ccc;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }

  .tab:hover { background: rgba(255,255,255,0.12); }
  .tab.active { background: #ffd700; color: #1a1a2e; font-weight: 700; border-color: #ffd700; }

  .panel { display: none; }
  .panel.active { display: block; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 12px;
  }

  th, td {
    padding: 10px 8px;
    text-align: left;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  th { color: #ffd700; font-weight: 600; font-size: 12px; text-transform: uppercase; }

  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: opacity 0.2s;
  }

  .btn:hover { opacity: 0.85; }
  .btn-gold { background: #ffd700; color: #1a1a2e; }
  .btn-red { background: #e74c3c; color: #fff; }
  .btn-green { background: #27ae60; color: #fff; }
  .btn-small { padding: 5px 10px; font-size: 12px; }

  .actions { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }

  .stat-card {
    background: rgba(255,255,255,0.06);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    text-align: center;
  }

  .stat-card .num { font-size: 32px; font-weight: 700; color: #ffd700; }
  .stat-card .label { font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 4px; }

  .form-group { margin-bottom: 12px; }
  .form-group label { display: block; font-size: 13px; color: #aaa; margin-bottom: 4px; }
  .form-group input, .form-group select {
    width: 100%;
    padding: 10px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
  }

  .msg {
    padding: 10px 14px;
    border-radius: 8px;
    margin-bottom: 12px;
    font-size: 13px;
    display: none;
  }

  .msg.ok { background: rgba(39,174,96,0.2); color: #2ecc71; display: block; }
  .msg.err { background: rgba(231,76,60,0.2); color: #e74c3c; display: block; }

  .no-access {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255,255,255,0.5);
    font-size: 16px;
  }

  @media (max-width: 600px) {
    table { font-size: 11px; }
    th, td { padding: 7px 4px; }
  }
</style>
</head>
<body>

<div id="app" style="display:none; max-width: 800px; margin: 0 auto;">
  <h1>üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>

  <div class="tabs">
    <div class="tab active" onclick="showTab('results')">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
    <div class="tab" onclick="showTab('prizes')">–ü—Ä–∏–∑—ã</div>
    <div class="tab" onclick="showTab('users')">–î–æ—Å—Ç—É–ø</div>
  </div>

  <div id="msg" class="msg"></div>

  <!-- ============ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã ============ -->
  <div id="panel-results" class="panel active">
    <div class="stat-card">
      <div class="num" id="totalSpins">‚Äî</div>
      <div class="label">–≤—Å–µ–≥–æ –≤—Ä–∞—â–µ–Ω–∏–π</div>
    </div>
    <div class="form-group" style="margin-bottom:12px">
      <input id="searchResults" type="text" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, username –∏–ª–∏ Telegram ID..." oninput="filterResults()">
    </div>
    <div class="actions">
      <button class="btn btn-gold" onclick="exportCSV()">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      <button class="btn btn-red" onclick="resetResults()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
    </div>
    <table>
      <thead>
        <tr><th>ID</th><th>Telegram ID</th><th>Username</th><th>–ò–º—è</th><th>–ü—Ä–∏–∑</th><th>–î–∞—Ç–∞</th><th></th></tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>

  <!-- ============ –ü—Ä–∏–∑—ã ============ -->
  <div id="panel-prizes" class="panel">
    <div class="actions">
      <button class="btn btn-green" onclick="showAddPrize()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑</button>
    </div>
    <div id="addPrizeForm" style="display:none; background: rgba(255,255,255,0.04); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
      <div class="form-group"><label>–¢–µ–∫—Å—Ç –ø—Ä–∏–∑–∞</label><input id="newPrizeText" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π"></div>
      <div class="form-group"><label>–ò–∫–æ–Ω–∫–∞ (—ç–º–æ–¥–∑–∏)</label><input id="newPrizeIcon" placeholder="üå¥" maxlength="4"></div>
      <div class="form-group"><label>–¶–≤–µ—Ç</label><input id="newPrizeColor" type="color" value="#4A90D9"></div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn btn-green" onclick="addPrize()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-small" style="background:rgba(255,255,255,0.1);color:#ccc;" onclick="document.getElementById('addPrizeForm').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
    <table>
      <thead>
        <tr><th>‚Ññ</th><th>–ò–∫–æ–Ω–∫–∞</th><th>–ü—Ä–∏–∑</th><th>–¶–≤–µ—Ç</th><th>–ê–∫—Ç–∏–≤–µ–Ω</th><th></th></tr>
      </thead>
      <tbody id="prizesBody"></tbody>
    </table>
  </div>

  <!-- ============ –î–æ—Å—Ç—É–ø ============ -->
  <div id="panel-users" class="panel">
    <div style="background: rgba(255,255,255,0.04); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
      <div class="form-group"><label>Telegram ID</label><input id="newUserId" type="number" placeholder="123456789"></div>
      <div class="form-group">
        <label>–†–æ–ª—å</label>
        <select id="newUserRole"><option value="admin">–ê–¥–º–∏–Ω</option><option value="viewer">–ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫</option></select>
      </div>
      <button class="btn btn-green" onclick="addUser()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <table>
      <thead>
        <tr><th>ID</th><th>Telegram ID</th><th>–†–æ–ª—å</th><th>–î–æ–±–∞–≤–∏–ª</th><th></th></tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>
  </div>
</div>

<div id="noAccess" class="no-access" style="display:none;">
  ‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.<br>–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ Telegram Mini App.
</div>

<script>
const tg = window.Telegram && window.Telegram.WebApp;
let initData = '';

if (tg) {
  tg.ready();
  initData = tg.initData || '';
}

function headers() {
  return { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': initData };
}

function showMsg(text, ok) {
  const el = document.getElementById('msg');
  el.textContent = text;
  el.className = 'msg ' + (ok ? 'ok' : 'err');
  setTimeout(() => { el.className = 'msg'; }, 3000);
}

function showTab(name) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', t.textContent.trim() === { results: '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã', prizes: '–ü—Ä–∏–∑—ã', users: '–î–æ—Å—Ç—É–ø' }[name]);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  if (name === 'results') loadResults();
  if (name === 'prizes') loadPrizes();
  if (name === 'users') loadUsers();
}

// ---- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã ----
let allResults = [];

async function loadResults() {
  try {
    const res = await fetch('/api/admin/results', { headers: headers() });
    if (!res.ok) throw new Error(res.status);
    allResults = await res.json();
    document.getElementById('totalSpins').textContent = allResults.length;
    document.getElementById('searchResults').value = '';
    renderResults(allResults);
  } catch (e) {
    document.getElementById('noAccess').style.display = 'block';
    document.getElementById('app').style.display = 'none';
  }
}

function filterResults() {
  const q = document.getElementById('searchResults').value.toLowerCase().trim();
  if (!q) { renderResults(allResults); return; }
  const filtered = allResults.filter(s =>
    (s.tg_username || '').toLowerCase().includes(q) ||
    (s.tg_first_name || '').toLowerCase().includes(q) ||
    (s.tg_last_name || '').toLowerCase().includes(q) ||
    String(s.tg_user_id).includes(q)
  );
  renderResults(filtered);
}

function renderResults(data) {
  const tbody = document.getElementById('resultsBody');
  tbody.innerHTML = data.map(s => `<tr>
    <td>${s.id}</td>
    <td>${s.tg_user_id}</td>
    <td>@${s.tg_username || '‚Äî'}</td>
    <td>${s.tg_first_name || ''} ${s.tg_last_name || ''}</td>
    <td>${s.prize_text}</td>
    <td>${s.created_at ? new Date(s.created_at).toLocaleString('ru') : ''}</td>
    <td><button class="btn btn-red btn-small" onclick="deleteResult(${s.id})">‚úï</button></td>
  </tr>`).join('');
}

async function deleteResult(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å #' + id + '?')) return;
  const res = await fetch('/api/admin/results/' + id, { method: 'DELETE', headers: headers() });
  if (res.ok) { showMsg('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', true); loadResults(); }
  else showMsg('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', false);
}

async function resetResults() {
  if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –í–°–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã? –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –∫—Ä—É—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ.')) return;
  const res = await fetch('/api/admin/reset', { method: 'POST', headers: headers() });
  if (res.ok) { showMsg('–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã', true); loadResults(); }
  else showMsg('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞', false);
}

async function exportCSV() {
  try {
    const res = await fetch('/api/admin/export', { headers: headers() });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();

    // –í Telegram WebView: –∫–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (—Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
    if (tg) {
      await navigator.clipboard.writeText(text);
      showMsg('CSV —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ ‚Äî –≤—Å—Ç–∞–≤—å—Ç–µ –≤ —Ñ–∞–π–ª –∏–ª–∏ —á–∞—Ç', true);
      return;
    }

    // –í –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ: —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'results.csv';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 3000);
  } catch (e) {
    showMsg('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message, false);
  }
}

// ---- –ü—Ä–∏–∑—ã ----
async function loadPrizes() {
  const res = await fetch('/api/admin/prizes', { headers: headers() });
  if (!res.ok) return;
  const data = await res.json();
  const tbody = document.getElementById('prizesBody');
  tbody.innerHTML = data.map(p => `<tr>
    <td>${p.position}</td>
    <td style="font-size:20px">${p.icon}</td>
    <td>${p.text}</td>
    <td><span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:${p.color}"></span> ${p.color}</td>
    <td>${p.is_active ? '‚úÖ' : '‚ùå'}</td>
    <td><button class="btn btn-red btn-small" onclick="deletePrize(${p.id})">‚úï</button></td>
  </tr>`).join('');
}

function showAddPrize() {
  document.getElementById('addPrizeForm').style.display = 'block';
}

async function addPrize() {
  const text = document.getElementById('newPrizeText').value.trim();
  const icon = document.getElementById('newPrizeIcon').value.trim();
  const color = document.getElementById('newPrizeColor').value;
  if (!text || !icon) { showMsg('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ –∏–∫–æ–Ω–∫—É', false); return; }

  const res = await fetch('/api/admin/prizes', {
    method: 'POST',
    headers: headers(),
    body: JSON.stringify({ text, icon, color, position: 0 })
  });
  if (res.ok) {
    showMsg('–ü—Ä–∏–∑ –¥–æ–±–∞–≤–ª–µ–Ω', true);
    document.getElementById('addPrizeForm').style.display = 'none';
    document.getElementById('newPrizeText').value = '';
    document.getElementById('newPrizeIcon').value = '';
    loadPrizes();
  } else {
    const err = await res.json().catch(() => ({}));
    showMsg(err.detail || '–û—à–∏–±–∫–∞', false);
  }
}

async function deletePrize(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∑ #' + id + '?')) return;
  const res = await fetch('/api/admin/prizes/' + id, { method: 'DELETE', headers: headers() });
  if (res.ok) { showMsg('–ü—Ä–∏–∑ —É–¥–∞–ª—ë–Ω', true); loadPrizes(); }
  else {
    const err = await res.json().catch(() => ({}));
    showMsg(err.detail || '–û—à–∏–±–∫–∞', false);
  }
}

// ---- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ----
async function loadUsers() {
  const res = await fetch('/api/admin/users', { headers: headers() });
  if (!res.ok) return;
  const data = await res.json();
  const tbody = document.getElementById('usersBody');
  tbody.innerHTML = data.map(u => `<tr>
    <td>${u.id}</td>
    <td>${u.tg_user_id}</td>
    <td>${u.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫'}</td>
    <td>${u.added_by || '‚Äî'}</td>
    <td><button class="btn btn-red btn-small" onclick="deleteUser(${u.id})">‚úï</button></td>
  </tr>`).join('');
}

async function addUser() {
  const tg_user_id = parseInt(document.getElementById('newUserId').value);
  const role = document.getElementById('newUserRole').value;
  if (!tg_user_id) { showMsg('–í–≤–µ–¥–∏—Ç–µ Telegram ID', false); return; }

  const res = await fetch('/api/admin/users', {
    method: 'POST',
    headers: headers(),
    body: JSON.stringify({ tg_user_id, role })
  });
  if (res.ok) {
    showMsg('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω', true);
    document.getElementById('newUserId').value = '';
    loadUsers();
  } else {
    const err = await res.json().catch(() => ({}));
    showMsg(err.detail || '–û—à–∏–±–∫–∞', false);
  }
}

async function deleteUser(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
  const res = await fetch('/api/admin/users/' + id, { method: 'DELETE', headers: headers() });
  if (res.ok) { showMsg('–£–¥–∞–ª–µ–Ω–æ', true); loadUsers(); }
  else showMsg('–û—à–∏–±–∫–∞', false);
}

// ---- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ----
async function initAdmin() {
  try {
    const res = await fetch('/api/admin/results', { headers: headers() });
    if (res.ok) {
      document.getElementById('app').style.display = 'block';
      loadResults();
    } else {
      document.getElementById('noAccess').style.display = 'block';
    }
  } catch (e) {
    document.getElementById('noAccess').style.display = 'block';
  }
}

initAdmin();
</script>
</body>
</html>
