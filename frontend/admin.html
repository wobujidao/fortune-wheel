<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
    padding: 16px;
  }

  h1 {
    text-align: center;
    font-size: 18px;
    color: #ffd700;
    margin-bottom: 12px;
  }

  /* ---- –¢–∞–±—ã ---- */
  .tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    flex-wrap: nowrap;
  }
  .tabs::-webkit-scrollbar { display: none; }

  .tab {
    padding: 8px 14px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    color: #ccc;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .tab:hover { background: rgba(255,255,255,0.12); }
  .tab.active { background: #ffd700; color: #1a1a2e; font-weight: 700; border-color: #ffd700; }

  .panel { display: none; }
  .panel.active { display: block; }

  /* ---- –¢–∞–±–ª–∏—Ü—ã ---- */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 12px;
  }

  th, td {
    padding: 10px 8px;
    text-align: left;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  th { color: #ffd700; font-weight: 600; font-size: 12px; text-transform: uppercase; }

  /* ---- –ö–Ω–æ–ø–∫–∏ ---- */
  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: opacity 0.2s;
  }

  .btn:hover { opacity: 0.85; }
  .btn-gold { background: #ffd700; color: #1a1a2e; }
  .btn-red { background: #e74c3c; color: #fff; }
  .btn-green { background: #27ae60; color: #fff; }
  .btn-small { padding: 5px 10px; font-size: 12px; }
  .btn-ghost { background: rgba(255,255,255,0.1); color: #ccc; }

  .actions { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }

  /* ---- Stat card ---- */
  .stat-card {
    background: rgba(255,255,255,0.06);
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 12px;
    text-align: center;
  }

  .stat-card .num { font-size: 28px; font-weight: 700; color: #ffd700; }
  .stat-card .label { font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 2px; }

  /* ---- –§–æ—Ä–º—ã ---- */
  .form-group { margin-bottom: 12px; }
  .form-group label { display: block; font-size: 13px; color: #aaa; margin-bottom: 4px; }
  .form-group input, .form-group select {
    width: 100%;
    padding: 10px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
  }

  /* ---- No access ---- */
  .no-access {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255,255,255,0.5);
    font-size: 16px;
  }

  /* ---- Dev mode toggle ---- */
  .dev-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: rgba(255,255,255,0.04);
    border-radius: 10px;
    margin-top: 24px;
  }

  .dev-toggle label {
    font-size: 13px;
    color: #aaa;
    cursor: pointer;
  }

  .dev-switch {
    position: relative;
    width: 44px;
    height: 24px;
    cursor: pointer;
  }

  .dev-switch input { display: none; }

  .dev-switch .slider {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.15);
    border-radius: 12px;
    transition: background 0.3s;
  }

  .dev-switch .slider::after {
    content: '';
    position: absolute;
    top: 3px; left: 3px;
    width: 18px; height: 18px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.3s;
  }

  .dev-switch input:checked + .slider {
    background: #27ae60;
  }

  .dev-switch input:checked + .slider::after {
    transform: translateX(20px);
  }

  /* ---- Drag & Drop ---- */
  tr[draggable="true"] { cursor: grab; }
  tr[draggable="true"]:active { cursor: grabbing; }
  tr.dragging { opacity: 0.4; }
  tr.drag-over td { border-top: 2px solid #ffd700; }

  /* ---- Stats bars ---- */
  .stats-section { margin-bottom: 24px; }
  .stats-section h3 { font-size: 14px; color: #ffd700; margin-bottom: 10px; }
  .stat-bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; }
  .stat-bar-label { width: 40%; min-width: 80px; color: rgba(255,255,255,0.8); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .stat-bar-track { flex: 1; height: 20px; background: rgba(255,255,255,0.06); border-radius: 4px; overflow: hidden; }
  .stat-bar-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, #ffd700, #ff8c00); transition: width 0.4s ease; display: flex; align-items: center; padding-left: 6px; font-size: 11px; font-weight: 700; color: #1a1a2e; min-width: 24px; }
  .stat-bar-fill.teal { background: linear-gradient(90deg, #2dd4bf, #0891b2); }

  /* ---- Audit badges ---- */
  .action-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    background: rgba(255,255,255,0.08);
  }

  /* ---- Settings pointer style ---- */
  .style-options { display: flex; gap: 12px; flex-wrap: wrap; }
  .style-card {
    flex: 1;
    min-width: 120px;
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }
  .style-card:hover { border-color: rgba(255,215,0,0.4); }
  .style-card.selected { border-color: #ffd700; background: rgba(255,215,0,0.08); }
  .style-card .style-icon { font-size: 40px; margin-bottom: 8px; display: block; }
  .style-card .style-label { font-size: 13px; font-weight: 600; color: #e0e0e0; }
  .style-card .style-desc { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 4px; }

  /* ---- Settings section ---- */
  .settings-section {
    margin-bottom: 24px;
  }
  .settings-section h3 {
    font-size: 14px;
    color: #ffd700;
    margin-bottom: 12px;
  }

  /* ---- Toast ---- */
  .toast-container {
    position: fixed;
    bottom: 24px; left: 50%;
    transform: translateX(-50%);
    z-index: 300;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    pointer-events: none;
  }
  .toast {
    background: rgba(30,30,58,0.95);
    border: 1px solid rgba(255,215,0,0.3);
    color: #fff;
    padding: 10px 20px;
    border-radius: 12px;
    font-size: 13px;
    backdrop-filter: blur(8px);
    animation: toastIn 0.3s ease, toastOut 0.3s ease 3.2s forwards;
    pointer-events: auto;
    max-width: 90vw;
    text-align: center;
  }
  .toast.ok { border-color: rgba(39,174,96,0.5); color: #2ecc71; }
  .toast.error { border-color: rgba(231,76,60,0.5); color: #ff6b6b; }
  @keyframes toastIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }

  /* ---- Confirm dialog ---- */
  .confirm-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(6px);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .confirm-overlay.show { display: flex; animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .confirm-dialog {
    background: linear-gradient(135deg, #1e1e3a, #2a2a4a);
    border-radius: 16px;
    padding: 24px 20px;
    max-width: min(340px, 90vw);
    width: 100%;
    border: 1px solid rgba(255,215,0,0.2);
    box-shadow: 0 16px 48px rgba(0,0,0,0.5);
    animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes modalPop { from { transform: scale(0.85); opacity: 0; } to { transform: scale(1); opacity: 1; } }

  .confirm-title { font-size: 16px; font-weight: 700; color: #ffd700; margin-bottom: 8px; }
  .confirm-text { font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 20px; line-height: 1.4; }
  .confirm-buttons { display: flex; gap: 10px; justify-content: flex-end; }
  .confirm-buttons .btn { min-width: 80px; padding: 10px 20px; }

  /* ---- Empty state ---- */
  .empty-state {
    text-align: center;
    padding: 32px 16px;
    color: rgba(255,255,255,0.35);
    font-size: 14px;
  }
  .empty-state .empty-icon { font-size: 40px; margin-bottom: 8px; display: block; }

  /* ---- Panel loading ---- */
  .panel-loading {
    text-align: center;
    padding: 32px;
    display: none;
  }
  .panel-loading.show { display: block; }
  .panel-spinner {
    width: 32px; height: 32px;
    border: 3px solid rgba(255,215,0,0.2);
    border-top-color: #ffd700;
    border-radius: 50%;
    animation: spinLoader 0.8s linear infinite;
    margin: 0 auto;
  }
  @keyframes spinLoader { to { transform: rotate(360deg); } }

  /* ---- Mobile cards ---- */
  @media (max-width: 600px) {
    body { padding: 12px; }

    table thead { display: none; }

    table tbody tr {
      display: block;
      background: rgba(255,255,255,0.04);
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-bottom: none;
    }

    /* Drag & drop cards */
    table tbody tr[draggable="true"] { cursor: grab; }
    table tbody tr.drag-over { border-top: 2px solid #ffd700; }
    table tbody tr.drag-over td { border-top: none; }

    table tbody td {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
      border-bottom: none;
      font-size: 13px;
    }

    table tbody td::before {
      content: attr(data-label);
      font-weight: 600;
      color: rgba(255,215,0,0.7);
      font-size: 11px;
      text-transform: uppercase;
      margin-right: 10px;
      flex-shrink: 0;
    }

    table tbody td.td-actions {
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
      padding-top: 6px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    table tbody td.td-actions::before { content: none; }

    .hide-mobile { display: none !important; }

    .stat-bar-label { width: 35%; min-width: 60px; font-size: 11px; }
  }

  /* ---- Role-based visibility ---- */
  .admin-only { display: none; }
  body.role-admin .admin-only { display: revert; }
  /* Tabs: flex items need flex display */
  body.role-admin .tab.admin-only { display: inline-flex; }
</style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-dialog">
    <div class="confirm-title" id="confirmTitle"></div>
    <div class="confirm-text" id="confirmText"></div>
    <div class="confirm-buttons">
      <button class="btn btn-ghost" id="confirmNo">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-red" id="confirmYes">–î–∞</button>
    </div>
  </div>
</div>

<div id="app" style="display:none; max-width: 800px; margin: 0 auto;">
  <h1>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>

  <div class="tabs">
    <div class="tab active" onclick="showTab('results')">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
    <div class="tab" onclick="showTab('prizes')">üéÅ –ü—Ä–∏–∑—ã</div>
    <div class="tab admin-only" onclick="showTab('users')">üë• –î–æ—Å—Ç—É–ø</div>
    <div class="tab admin-only" onclick="showTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div class="tab admin-only" onclick="showTab('audit')">üìã –õ–æ–≥</div>
  </div>

  <!-- ============ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã ============ -->
  <div id="panel-results" class="panel active">
    <div class="panel-loading" id="loadingResults"><div class="panel-spinner"></div></div>
    <div id="resultsContent" style="display:none;">
      <div class="stat-card">
        <div class="num" id="totalSpins">‚Äî</div>
        <div class="label">–≤—Å–µ–≥–æ –≤—Ä–∞—â–µ–Ω–∏–π</div>
      </div>
      <div class="form-group" style="margin-bottom:12px">
        <input id="searchResults" type="text" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, username –∏–ª–∏ ID..." oninput="filterResults()">
      </div>
      <div class="actions">
        <button class="btn btn-gold" onclick="exportCSV()">üì• CSV</button>
        <button class="btn btn-red admin-only" onclick="resetResults()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
      </div>
      <div id="statsContainer"></div>
      <table>
        <thead>
          <tr><th>ID</th><th>Telegram ID</th><th>Username</th><th>–ò–º—è</th><th>–ü—Ä–∏–∑</th><th>–î–∞—Ç–∞</th><th></th></tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
      <div class="empty-state" id="emptyResults" style="display:none;">
        <span class="empty-icon">üé∞</span>
        –ü–æ–∫–∞ –Ω–µ—Ç –≤—Ä–∞—â–µ–Ω–∏–π
      </div>
    </div>
  </div>

  <!-- ============ –ü—Ä–∏–∑—ã ============ -->
  <div id="panel-prizes" class="panel">
    <div class="panel-loading" id="loadingPrizes"><div class="panel-spinner"></div></div>
    <div id="prizesContent" style="display:none;">
      <div class="actions admin-only">
        <button class="btn btn-green" onclick="showAddPrize()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑</button>
      </div>
      <div id="prizeForm" style="display:none; background: rgba(255,255,255,0.04); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
        <div id="prizeFormTitle" style="font-size:14px; font-weight:600; color:#ffd700; margin-bottom:12px;">–ù–æ–≤—ã–π –ø—Ä–∏–∑</div>
        <input type="hidden" id="editPrizeId" value="">
        <div class="form-group"><label>–¢–µ–∫—Å—Ç –ø—Ä–∏–∑–∞</label><input id="newPrizeText" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π"></div>
        <div class="form-group"><label>–ò–∫–æ–Ω–∫–∞ (—ç–º–æ–¥–∑–∏)</label><input id="newPrizeIcon" placeholder="üå¥" maxlength="4"></div>
        <div class="form-group"><label>–¶–≤–µ—Ç</label><input id="newPrizeColor" type="color" value="#4A90D9"></div>
        <div class="form-group"><label>–ü–æ–∑–∏—Ü–∏—è</label><input id="newPrizePosition" type="number" min="1" max="100" value="1"></div>
        <div class="form-group" id="prizeActiveGroup" style="display:none;">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
            <input type="checkbox" id="newPrizeActive" checked> –ê–∫—Ç–∏–≤–µ–Ω
          </label>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn btn-green" onclick="savePrize()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn btn-small btn-ghost" onclick="closePrizeForm()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
      <table>
        <thead>
          <tr><th>‚Ññ</th><th>–ò–∫–æ–Ω–∫–∞</th><th>–ü—Ä–∏–∑</th><th>–¶–≤–µ—Ç</th><th>–ê–∫—Ç–∏–≤–µ–Ω</th><th></th></tr>
        </thead>
        <tbody id="prizesBody"></tbody>
      </table>
      <div class="empty-state" id="emptyPrizes" style="display:none;">
        <span class="empty-icon">üéÅ</span>
        –ù–µ—Ç –ø—Ä–∏–∑–æ–≤ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π
      </div>
    </div>
  </div>

  <!-- ============ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ============ -->
  <div id="panel-settings" class="panel">
    <div class="settings-section">
      <h3>–°—Ç–∏–ª—å —É–∫–∞–∑–∞—Ç–µ–ª—è</h3>
      <div class="style-options" id="pointerStyleOptions">
        <div class="style-card" data-value="top" onclick="setPointerStyle('top')">
          <span class="style-icon">‚¨áÔ∏è</span>
          <div class="style-label">–°–≤–µ—Ä—Ö—É</div>
          <div class="style-desc">–°—Ç—Ä–µ–ª–∫–∞ —Å–≤–µ—Ä—Ö—É –∫–æ–ª–µ—Å–∞, –æ—Å—Ç—Ä–∏—ë–º –∫ —Ü–µ–Ω—Ç—Ä—É</div>
        </div>
        <div class="style-card" data-value="center" onclick="setPointerStyle('center')">
          <span class="style-icon">‚¨ÜÔ∏è</span>
          <div class="style-label">–ò–∑ —Ü–µ–Ω—Ç—Ä–∞</div>
          <div class="style-desc">–°—Ç—Ä–µ–ª–∫–∞ –∏–∑ —Ö–∞–±–∞ –≤–≤–µ—Ä—Ö, —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–∏–∑</div>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <h3>–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏</h3>
      <div class="dev-toggle">
        <label for="devModeSwitch">–ö–æ–ª–µ—Å–æ –∫—Ä—É—Ç–∏—Ç—Å—è –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</label>
        <label class="dev-switch">
          <input type="checkbox" id="devModeSwitch" onchange="toggleDevMode(this.checked)">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

  <!-- ============ –õ–æ–≥ ============ -->
  <div id="panel-audit" class="panel">
    <div class="panel-loading" id="loadingAudit"><div class="panel-spinner"></div></div>
    <div id="auditContent" style="display:none;">
      <table>
        <thead>
          <tr><th>–î–∞—Ç–∞</th><th>–ê–¥–º–∏–Ω</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–î–µ—Ç–∞–ª–∏</th></tr>
        </thead>
        <tbody id="auditBody"></tbody>
      </table>
      <div class="empty-state" id="emptyAudit" style="display:none;">
        <span class="empty-icon">üìã</span>
        –õ–æ–≥ –ø—É—Å—Ç
      </div>
    </div>
  </div>

  <!-- ============ –î–æ—Å—Ç—É–ø ============ -->
  <div id="panel-users" class="panel">
    <div class="panel-loading" id="loadingUsers"><div class="panel-spinner"></div></div>
    <div id="usersContent" style="display:none;">
      <div style="background: rgba(255,255,255,0.04); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
        <div class="form-group"><label>Telegram ID</label><input id="newUserId" type="number" placeholder="123456789"></div>
        <div class="form-group">
          <label>–†–æ–ª—å</label>
          <select id="newUserRole"><option value="admin">–ê–¥–º–∏–Ω</option><option value="viewer">–ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫</option></select>
        </div>
        <button class="btn btn-green" onclick="addUser()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <table>
        <thead>
          <tr><th>ID</th><th>Telegram ID</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–†–æ–ª—å</th><th>–î–æ–±–∞–≤–∏–ª</th><th></th></tr>
        </thead>
        <tbody id="usersBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="noAccess" class="no-access" style="display:none;">
  ‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.<br>–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ Telegram Mini App.
</div>

<script>
const tg = window.Telegram && window.Telegram.WebApp;
let initData = '';

if (tg) {
  tg.ready();
  initData = tg.initData || '';
}

let userRole = 'viewer'; // –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤ initAdmin()

function isAdmin() { return userRole === 'admin'; }

function headers() {
  return { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': initData };
}

// ---- Toast notifications ----
function showMsg(text, ok) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast ' + (ok ? 'ok' : 'error');
  t.textContent = text;
  c.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// ---- Custom confirm dialog ----
function customConfirm(title, text) {
  return new Promise(resolve => {
    const overlay = document.getElementById('confirmOverlay');
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmText').textContent = text;
    overlay.classList.add('show');

    function cleanup(result) {
      overlay.classList.remove('show');
      document.getElementById('confirmYes').removeEventListener('click', onYes);
      document.getElementById('confirmNo').removeEventListener('click', onNo);
      resolve(result);
    }

    function onYes() { cleanup(true); }
    function onNo() { cleanup(false); }

    document.getElementById('confirmYes').addEventListener('click', onYes);
    document.getElementById('confirmNo').addEventListener('click', onNo);
  });
}

// ---- Loading helpers ----
function showLoading(panelName) {
  const loader = document.getElementById('loading' + panelName);
  const content = document.getElementById(panelName.toLowerCase() + 'Content');
  if (loader) loader.classList.add('show');
  if (content) content.style.display = 'none';
}

function hideLoading(panelName) {
  const loader = document.getElementById('loading' + panelName);
  const content = document.getElementById(panelName.toLowerCase() + 'Content');
  if (loader) loader.classList.remove('show');
  if (content) content.style.display = 'block';
}

// ---- Tabs ----
const TAB_NAMES = { results: 'üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã', prizes: 'üéÅ –ü—Ä–∏–∑—ã', users: 'üë• –î–æ—Å—Ç—É–ø', settings: '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏', audit: 'üìã –õ–æ–≥' };

function showTab(name) {
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.toggle('active', t.textContent.trim() === TAB_NAMES[name]);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  if (name === 'results') loadResults();
  if (name === 'prizes') loadPrizes();
  if (name === 'users') loadUsers();
  if (name === 'settings') loadSettings();
  if (name === 'audit') loadAudit();
}

// ---- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã ----
let allResults = [];

async function loadResults() {
  showLoading('Results');
  try {
    const res = await fetch('/api/admin/results', { headers: headers() });
    if (!res.ok) throw new Error(res.status);
    allResults = await res.json();
    document.getElementById('totalSpins').textContent = allResults.length;
    document.getElementById('searchResults').value = '';
    renderResults(allResults);
    renderStats();
    hideLoading('Results');
  } catch (e) {
    document.getElementById('noAccess').style.display = 'block';
    document.getElementById('app').style.display = 'none';
  }
}

function filterResults() {
  const q = document.getElementById('searchResults').value.toLowerCase().trim();
  if (!q) { renderResults(allResults); return; }
  const filtered = allResults.filter(s =>
    (s.tg_username || '').toLowerCase().includes(q) ||
    (s.tg_first_name || '').toLowerCase().includes(q) ||
    (s.tg_last_name || '').toLowerCase().includes(q) ||
    String(s.tg_user_id).includes(q)
  );
  renderResults(filtered);
}

function renderResults(data) {
  const tbody = document.getElementById('resultsBody');
  const empty = document.getElementById('emptyResults');
  tbody.innerHTML = '';

  if (!data.length) {
    empty.style.display = 'block';
    tbody.parentElement.style.display = 'none';
    return;
  }
  empty.style.display = 'none';
  tbody.parentElement.style.display = '';

  data.forEach(s => {
    const tr = document.createElement('tr');

    const tdId = document.createElement('td');
    tdId.textContent = s.id;
    tdId.dataset.label = 'ID';
    tdId.classList.add('hide-mobile');
    tr.appendChild(tdId);

    const tdTgId = document.createElement('td');
    tdTgId.textContent = s.tg_user_id;
    tdTgId.dataset.label = 'Telegram ID';
    tr.appendChild(tdTgId);

    const tdUser = document.createElement('td');
    tdUser.textContent = '@' + (s.tg_username || '‚Äî');
    tdUser.dataset.label = 'Username';
    tr.appendChild(tdUser);

    const tdName = document.createElement('td');
    tdName.textContent = ((s.tg_first_name || '') + ' ' + (s.tg_last_name || '')).trim() || '‚Äî';
    tdName.dataset.label = '–ò–º—è';
    tr.appendChild(tdName);

    const tdPrize = document.createElement('td');
    tdPrize.textContent = s.prize_text;
    tdPrize.dataset.label = '–ü—Ä–∏–∑';
    tr.appendChild(tdPrize);

    const tdDate = document.createElement('td');
    tdDate.textContent = s.created_at ? new Date(s.created_at).toLocaleString('ru') : '';
    tdDate.dataset.label = '–î–∞—Ç–∞';
    tr.appendChild(tdDate);

    if (isAdmin()) {
      const tdBtn = document.createElement('td');
      tdBtn.className = 'td-actions';
      const btn = document.createElement('button');
      btn.className = 'btn btn-red btn-small';
      btn.textContent = '‚úï';
      btn.addEventListener('click', () => deleteResult(s.id));
      tdBtn.appendChild(btn);
      tr.appendChild(tdBtn);
    }

    tbody.appendChild(tr);
  });
}

async function deleteResult(id) {
  const ok = await customConfirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å', '–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –≤—Ä–∞—â–µ–Ω–∏—è #' + id + '?');
  if (!ok) return;
  try {
    const res = await fetch('/api/admin/results/' + id, { method: 'DELETE', headers: headers() });
    if (res.ok) { showMsg('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', true); loadResults(); }
    else showMsg('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', false);
  } catch (e) { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); }
}

async function resetResults() {
  const ok = await customConfirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë', '–°–±—Ä–æ—Å–∏—Ç—å –í–°–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã? –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –∫—Ä—É—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ.');
  if (!ok) return;
  try {
    const res = await fetch('/api/admin/reset', { method: 'POST', headers: headers() });
    if (res.ok) { showMsg('–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã', true); loadResults(); }
    else showMsg('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞', false);
  } catch (e) { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); }
}

async function exportCSV() {
  try {
    const res = await fetch('/api/admin/export', { headers: headers() });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();

    // –í Telegram WebView: –∫–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    if (tg) {
      await navigator.clipboard.writeText(text);
      showMsg('CSV —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', true);
      return;
    }

    // –í –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ: —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'results.csv';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 3000);
  } catch (e) {
    showMsg('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message, false);
  }
}

// ---- –ü—Ä–∏–∑—ã ----
async function loadPrizes() {
  showLoading('Prizes');
  try {
    const res = await fetch('/api/admin/prizes', { headers: headers() });
    if (!res.ok) { showMsg('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–∑–æ–≤', false); hideLoading('Prizes'); return; }
    var data = await res.json();
  } catch (e) { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); hideLoading('Prizes'); return; }

  const tbody = document.getElementById('prizesBody');
  const empty = document.getElementById('emptyPrizes');
  tbody.innerHTML = '';

  if (!data.length) {
    empty.style.display = 'block';
    tbody.parentElement.style.display = 'none';
    hideLoading('Prizes');
    return;
  }
  empty.style.display = 'none';
  tbody.parentElement.style.display = '';

  data.forEach(p => {
    const tr = document.createElement('tr');
    tr.dataset.prizeId = p.id;

    const tdPos = document.createElement('td');
    tdPos.textContent = p.position;
    tdPos.dataset.label = '‚Ññ';
    tr.appendChild(tdPos);

    const tdIcon = document.createElement('td');
    tdIcon.style.fontSize = '20px';
    tdIcon.textContent = p.icon;
    tdIcon.dataset.label = '–ò–∫–æ–Ω–∫–∞';
    tr.appendChild(tdIcon);

    const tdText = document.createElement('td');
    tdText.textContent = p.text;
    tdText.dataset.label = '–ü—Ä–∏–∑';
    tr.appendChild(tdText);

    const tdColor = document.createElement('td');
    tdColor.dataset.label = '–¶–≤–µ—Ç';
    const span = document.createElement('span');
    span.style.cssText = 'display:inline-block;width:20px;height:20px;border-radius:4px;background:' + p.color + ';vertical-align:middle;';
    tdColor.appendChild(span);
    tdColor.append(' ' + p.color);
    tr.appendChild(tdColor);

    const tdActive = document.createElement('td');
    tdActive.textContent = p.is_active ? '‚úÖ' : '‚ùå';
    tdActive.dataset.label = '–ê–∫—Ç–∏–≤–µ–Ω';
    tr.appendChild(tdActive);

    if (isAdmin()) {
      const tdBtn = document.createElement('td');
      tdBtn.className = 'td-actions';
      tdBtn.style.cssText = 'display:flex; gap:4px;';
      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn btn-gold btn-small';
      btnEdit.textContent = '‚úèÔ∏è';
      btnEdit.addEventListener('click', () => editPrize(p));
      tdBtn.appendChild(btnEdit);
      const btn = document.createElement('button');
      btn.className = 'btn btn-red btn-small';
      btn.textContent = '‚úï';
      btn.addEventListener('click', () => deletePrize(p.id));
      tdBtn.appendChild(btn);
      tr.appendChild(tdBtn);
    }

    tbody.appendChild(tr);
  });
  if (isAdmin()) enablePrizeDragDrop();
  hideLoading('Prizes');
}

function showAddPrize() {
  document.getElementById('editPrizeId').value = '';
  document.getElementById('prizeFormTitle').textContent = '–ù–æ–≤—ã–π –ø—Ä–∏–∑';
  document.getElementById('newPrizeText').value = '';
  document.getElementById('newPrizeIcon').value = '';
  document.getElementById('newPrizeColor').value = '#4A90D9';
  document.getElementById('newPrizePosition').value = '1';
  document.getElementById('newPrizeActive').checked = true;
  document.getElementById('prizeActiveGroup').style.display = 'none';
  document.getElementById('prizeForm').style.display = 'block';
}

function editPrize(p) {
  document.getElementById('editPrizeId').value = p.id;
  document.getElementById('prizeFormTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞ #' + p.id;
  document.getElementById('newPrizeText').value = p.text;
  document.getElementById('newPrizeIcon').value = p.icon;
  document.getElementById('newPrizeColor').value = p.color;
  document.getElementById('newPrizePosition').value = p.position;
  document.getElementById('newPrizeActive').checked = p.is_active;
  document.getElementById('prizeActiveGroup').style.display = 'block';
  document.getElementById('prizeForm').style.display = 'block';
}

function closePrizeForm() {
  document.getElementById('prizeForm').style.display = 'none';
}

async function savePrize() {
  const editId = document.getElementById('editPrizeId').value;
  const text = document.getElementById('newPrizeText').value.trim();
  const icon = document.getElementById('newPrizeIcon').value.trim();
  const color = document.getElementById('newPrizeColor').value;
  const position = parseInt(document.getElementById('newPrizePosition').value) || 1;
  if (!text || !icon) { showMsg('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ –∏–∫–æ–Ω–∫—É', false); return; }

  try {
    let res;
    if (editId) {
      const is_active = document.getElementById('newPrizeActive').checked;
      res = await fetch('/api/admin/prizes/' + editId, {
        method: 'PUT',
        headers: headers(),
        body: JSON.stringify({ text, icon, color, position, is_active })
      });
    } else {
      res = await fetch('/api/admin/prizes', {
        method: 'POST',
        headers: headers(),
        body: JSON.stringify({ text, icon, color, position })
      });
    }

    if (res.ok) {
      showMsg(editId ? '–ü—Ä–∏–∑ –æ–±–Ω–æ–≤–ª—ë–Ω' : '–ü—Ä–∏–∑ –¥–æ–±–∞–≤–ª–µ–Ω', true);
      closePrizeForm();
      loadPrizes();
    } else {
      const err = await res.json().catch(() => ({}));
      showMsg(err.detail || '–û—à–∏–±–∫–∞', false);
    }
  } catch { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); }
}

async function deletePrize(id) {
  const ok = await customConfirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∑', '–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∑ #' + id + '?');
  if (!ok) return;
  try {
    const res = await fetch('/api/admin/prizes/' + id, { method: 'DELETE', headers: headers() });
    if (res.ok) { showMsg('–ü—Ä–∏–∑ —É–¥–∞–ª—ë–Ω', true); loadPrizes(); }
    else {
      const err = await res.json().catch(() => ({}));
      showMsg(err.detail || '–û—à–∏–±–∫–∞', false);
    }
  } catch { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); }
}

// ---- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ----
async function loadUsers() {
  showLoading('Users');
  let data;
  try {
    const res = await fetch('/api/admin/users', { headers: headers() });
    if (!res.ok) { showMsg('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', false); hideLoading('Users'); return; }
    data = await res.json();
  } catch (e) { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); hideLoading('Users'); return; }

  const tbody = document.getElementById('usersBody');
  tbody.innerHTML = '';

  data.forEach(u => {
    const tr = document.createElement('tr');
    const userDisplay = u.tg_first_name
      ? u.tg_first_name + (u.tg_username ? ' (@' + u.tg_username + ')' : '')
      : (u.tg_username ? '@' + u.tg_username : '‚Äî');

    const tdId = document.createElement('td');
    tdId.textContent = u.id;
    tdId.dataset.label = 'ID';
    tdId.classList.add('hide-mobile');
    tr.appendChild(tdId);

    const tdTgId = document.createElement('td');
    tdTgId.textContent = u.tg_user_id;
    tdTgId.dataset.label = 'Telegram ID';
    tr.appendChild(tdTgId);

    const tdUser = document.createElement('td');
    tdUser.textContent = userDisplay;
    tdUser.dataset.label = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    tr.appendChild(tdUser);

    const tdRole = document.createElement('td');
    tdRole.textContent = u.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫';
    tdRole.dataset.label = '–†–æ–ª—å';
    tr.appendChild(tdRole);

    const tdAdded = document.createElement('td');
    tdAdded.textContent = u.added_by || '‚Äî';
    tdAdded.dataset.label = '–î–æ–±–∞–≤–∏–ª';
    tdAdded.classList.add('hide-mobile');
    tr.appendChild(tdAdded);

    const tdBtn = document.createElement('td');
    tdBtn.className = 'td-actions';
    const btn = document.createElement('button');
    btn.className = 'btn btn-red btn-small';
    btn.textContent = '‚úï';
    btn.addEventListener('click', () => deleteUser(u.id));
    tdBtn.appendChild(btn);
    tr.appendChild(tdBtn);

    tbody.appendChild(tr);
  });
  hideLoading('Users');
}

async function addUser() {
  const tg_user_id = parseInt(document.getElementById('newUserId').value);
  const role = document.getElementById('newUserRole').value;
  if (!tg_user_id) { showMsg('–í–≤–µ–¥–∏—Ç–µ Telegram ID', false); return; }

  try {
    const res = await fetch('/api/admin/users', {
      method: 'POST',
      headers: headers(),
      body: JSON.stringify({ tg_user_id, role })
    });
    if (res.ok) {
      showMsg('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω', true);
      document.getElementById('newUserId').value = '';
      loadUsers();
    } else {
      const err = await res.json().catch(() => ({}));
      showMsg(err.detail || '–û—à–∏–±–∫–∞', false);
    }
  } catch { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); }
}

async function deleteUser(id) {
  const ok = await customConfirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', '–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–∏—Å—Ç–µ–º—ã?');
  if (!ok) return;
  try {
    const res = await fetch('/api/admin/users/' + id, { method: 'DELETE', headers: headers() });
    if (res.ok) { showMsg('–£–¥–∞–ª–µ–Ω–æ', true); loadUsers(); }
    else showMsg('–û—à–∏–±–∫–∞', false);
  } catch (e) { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); }
}

// ---- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ----
function renderStats() {
  const container = document.getElementById('statsContainer');
  container.innerHTML = '';
  if (!allResults.length) return;

  // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏–∑–∞–º
  const prizeCounts = {};
  allResults.forEach(s => { prizeCounts[s.prize_text] = (prizeCounts[s.prize_text] || 0) + 1; });
  const prizeEntries = Object.entries(prizeCounts).sort((a, b) => b[1] - a[1]);
  if (!prizeEntries.length) return;
  const maxPrize = prizeEntries[0][1];

  const prizeSection = document.createElement('div');
  prizeSection.className = 'stats-section';
  const prizeH = document.createElement('h3');
  prizeH.textContent = '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–æ–≤';
  prizeSection.appendChild(prizeH);
  prizeEntries.forEach(([name, count]) => {
    const row = document.createElement('div');
    row.className = 'stat-bar-row';
    const label = document.createElement('div');
    label.className = 'stat-bar-label';
    label.textContent = name;
    label.title = name;
    const track = document.createElement('div');
    track.className = 'stat-bar-track';
    const fill = document.createElement('div');
    fill.className = 'stat-bar-fill';
    fill.style.width = Math.round(count / maxPrize * 100) + '%';
    fill.textContent = count;
    track.appendChild(fill);
    row.appendChild(label);
    row.appendChild(track);
    prizeSection.appendChild(row);
  });
  container.appendChild(prizeSection);

  // –í—Ä–∞—â–µ–Ω–∏—è –ø–æ –¥–Ω—è–º
  const dayCounts = {};
  allResults.forEach(s => {
    if (!s.created_at) return;
    const day = s.created_at.substring(0, 10);
    dayCounts[day] = (dayCounts[day] || 0) + 1;
  });
  const dayEntries = Object.entries(dayCounts).sort((a, b) => a[0].localeCompare(b[0]));
  if (dayEntries.length > 1) {
    const maxDay = Math.max(...dayEntries.map(e => e[1]));
    const daySection = document.createElement('div');
    daySection.className = 'stats-section';
    const dayH = document.createElement('h3');
    dayH.textContent = '–í—Ä–∞—â–µ–Ω–∏—è –ø–æ –¥–Ω—è–º';
    daySection.appendChild(dayH);
    dayEntries.forEach(([day, count]) => {
      const row = document.createElement('div');
      row.className = 'stat-bar-row';
      const label = document.createElement('div');
      label.className = 'stat-bar-label';
      label.textContent = new Date(day).toLocaleDateString('ru', { day: 'numeric', month: 'short' });
      const track = document.createElement('div');
      track.className = 'stat-bar-track';
      const fill = document.createElement('div');
      fill.className = 'stat-bar-fill teal';
      fill.style.width = Math.round(count / maxDay * 100) + '%';
      fill.textContent = count;
      track.appendChild(fill);
      row.appendChild(label);
      row.appendChild(track);
      daySection.appendChild(row);
    });
    container.appendChild(daySection);
  }
}

// ---- Drag & Drop –ø—Ä–∏–∑–æ–≤ ----
let dragSrcRow = null;

function enablePrizeDragDrop() {
  const tbody = document.getElementById('prizesBody');
  tbody.querySelectorAll('tr').forEach(tr => {
    tr.setAttribute('draggable', 'true');
    // –°–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
    tr.removeEventListener('dragstart', handleDragStart);
    tr.removeEventListener('dragover', handleDragOver);
    tr.removeEventListener('dragenter', handleDragEnter);
    tr.removeEventListener('dragleave', handleDragLeave);
    tr.removeEventListener('drop', handleDrop);
    tr.removeEventListener('dragend', handleDragEnd);
    tr.addEventListener('dragstart', handleDragStart);
    tr.addEventListener('dragover', handleDragOver);
    tr.addEventListener('dragenter', handleDragEnter);
    tr.addEventListener('dragleave', handleDragLeave);
    tr.addEventListener('drop', handleDrop);
    tr.addEventListener('dragend', handleDragEnd);
  });
}

function handleDragStart(e) {
  dragSrcRow = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(e) {
  e.preventDefault();
  this.classList.add('drag-over');
}

function handleDragLeave() {
  this.classList.remove('drag-over');
}

function handleDrop(e) {
  e.preventDefault();
  if (dragSrcRow === this) return;
  const tbody = this.parentNode;
  const rows = Array.from(tbody.children);
  const srcIdx = rows.indexOf(dragSrcRow);
  const dstIdx = rows.indexOf(this);
  if (srcIdx < dstIdx) {
    tbody.insertBefore(dragSrcRow, this.nextSibling);
  } else {
    tbody.insertBefore(dragSrcRow, this);
  }
  this.classList.remove('drag-over');
  savePrizeOrder();
}

function handleDragEnd() {
  this.classList.remove('dragging');
  document.querySelectorAll('#prizesBody tr').forEach(tr => tr.classList.remove('drag-over'));
}

async function savePrizeOrder() {
  const rows = document.querySelectorAll('#prizesBody tr');
  const items = [];
  rows.forEach((tr, i) => {
    const id = parseInt(tr.dataset.prizeId);
    if (id) items.push({ id, position: i + 1 });
  });
  if (!items.length) return;
  try {
    const res = await fetch('/api/admin/prizes/reorder', {
      method: 'PUT',
      headers: headers(),
      body: JSON.stringify(items)
    });
    if (res.ok) {
      showMsg('–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω', true);
      loadPrizes();
    } else {
      showMsg('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞', false);
      loadPrizes();
    }
  } catch {
    showMsg('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞', false);
    loadPrizes();
  }
}

// ---- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ----
async function loadSettings() {
  try {
    const res = await fetch('/api/settings');
    if (!res.ok) return;
    const data = await res.json();
    highlightPointerStyle(data.pointer_style || 'top');
  } catch {}
}

function highlightPointerStyle(value) {
  document.querySelectorAll('#pointerStyleOptions .style-card').forEach(card => {
    card.classList.toggle('selected', card.dataset.value === value);
  });
}

async function setPointerStyle(value) {
  try {
    const res = await fetch('/api/admin/settings', {
      method: 'PUT',
      headers: headers(),
      body: JSON.stringify({ key: 'pointer_style', value })
    });
    if (res.ok) {
      showMsg('–°—Ç–∏–ª—å —É–∫–∞–∑–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—ë–Ω: ' + (value === 'top' ? '—Å–≤–µ—Ä—Ö—É' : '–∏–∑ —Ü–µ–Ω—Ç—Ä–∞'), true);
      highlightPointerStyle(value);
    } else {
      const err = await res.json().catch(() => ({}));
      showMsg(err.detail || '–û—à–∏–±–∫–∞', false);
    }
  } catch { showMsg('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', false); }
}

// ---- –ê—É–¥–∏—Ç-–ª–æ–≥ ----
const ACTION_LABELS = {
  delete_spin: 'üóë –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–∞—â–µ–Ω–∏—è',
  reset_all: 'üîÑ –°–±—Ä–æ—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤',
  create_prize: '‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–∞',
  update_prize: '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞',
  delete_prize: 'üóë –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–∞',
  reorder_prizes: '‚ÜïÔ∏è –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏–∑–æ–≤',
  add_user: 'üë§ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
  delete_user: 'üóë –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
  update_setting: '‚öôÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
};

async function loadAudit() {
  showLoading('Audit');
  try {
    const res = await fetch('/api/admin/audit', { headers: headers() });
    if (!res.ok) { hideLoading('Audit'); return; }
    const data = await res.json();
    const tbody = document.getElementById('auditBody');
    const empty = document.getElementById('emptyAudit');
    tbody.innerHTML = '';

    if (!data.length) {
      empty.style.display = 'block';
      tbody.parentElement.style.display = 'none';
      hideLoading('Audit');
      return;
    }
    empty.style.display = 'none';
    tbody.parentElement.style.display = '';

    data.forEach(log => {
      const tr = document.createElement('tr');

      const tdDate = document.createElement('td');
      tdDate.textContent = log.created_at ? new Date(log.created_at).toLocaleString('ru') : '';
      tdDate.dataset.label = '–î–∞—Ç–∞';
      tr.appendChild(tdDate);

      const tdAdmin = document.createElement('td');
      tdAdmin.textContent = log.admin_name || log.admin_id;
      tdAdmin.dataset.label = '–ê–¥–º–∏–Ω';
      tdAdmin.classList.add('hide-mobile');
      tr.appendChild(tdAdmin);

      const tdAction = document.createElement('td');
      tdAction.dataset.label = '–î–µ–π—Å—Ç–≤–∏–µ';
      const badge = document.createElement('span');
      badge.className = 'action-badge';
      badge.textContent = ACTION_LABELS[log.action] || log.action;
      tdAction.appendChild(badge);
      tr.appendChild(tdAction);

      const tdDetails = document.createElement('td');
      // –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º –¥–æ–±–∞–≤–ª—è–µ–º –∏–º—è –∞–¥–º–∏–Ω–∞ –≤ –¥–µ—Ç–∞–ª–∏
      const adminPrefix = log.admin_name ? log.admin_name + ': ' : '';
      tdDetails.textContent = adminPrefix + (log.details || '');
      tdDetails.dataset.label = '–î–µ—Ç–∞–ª–∏';
      tdDetails.style.color = 'rgba(255,255,255,0.6)';
      tdDetails.style.fontSize = '12px';
      tr.appendChild(tdDetails);

      tbody.appendChild(tr);
    });
    hideLoading('Audit');
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏—Ç-–ª–æ–≥–∞:', e);
    hideLoading('Audit');
  }
}

// ---- –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ----
function toggleDevMode(on) {
  if (on) {
    localStorage.setItem('devMode', '1');
    showMsg('–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á—ë–Ω ‚Äî –∫–æ–ª–µ—Å–æ –º–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π', true);
  } else {
    localStorage.removeItem('devMode');
    showMsg('–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω', true);
  }
}

// ---- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ----
async function initAdmin() {
  // BackButton –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –∞–¥–º–∏–Ω–∫–∏
  if (tg && tg.BackButton) {
    tg.BackButton.show();
    tg.BackButton.onClick(() => tg.close());
  }

  try {
    const res = await fetch('/api/admin/results', { headers: headers() });
    if (res.ok) {
      document.getElementById('app').style.display = 'block';

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å: –ø—Ä–æ–±—É–µ–º admin-only —ç–Ω–¥–ø–æ–∏–Ω—Ç
      try {
        const roleRes = await fetch('/api/admin/audit', { headers: headers() });
        if (roleRes.ok) {
          userRole = 'admin';
          document.body.classList.add('role-admin');
          document.getElementById('devModeSwitch').checked = localStorage.getItem('devMode') === '1';
        }
      } catch {}

      loadResults();
    } else {
      document.getElementById('noAccess').style.display = 'block';
    }
  } catch (e) {
    document.getElementById('noAccess').style.display = 'block';
  }
}

initAdmin();
</script>
</body>
</html>
